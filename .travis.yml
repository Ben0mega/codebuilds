sudo: required
dist: trusty
language: generic
services:
  - docker
cache:
  directories:
  - .cache
branches:
  only:
    - /^20.*$/
    - master

# Travis CI build matrix.  Each entry below will trigger an extra, parallel build on Travis.
matrix:
  include:
  - os: linux
    env:
     - arch="arm64"
     - COBBLER_GIT_ENDPOINT=https://github.com/Microsoft/vscode
     - COBBLER_PACKAGES="libgtk2.0-0 libxkbfile-dev 
libx11-dev libxdmcp-dev libdbus-1-3 libpcre3 libselinux1 libp11-kit0 libcomerr2 libk5crypto3 
libkrb5-3 libpango-1.0-0 libpangocairo-1.0-0 libpangoft2-1.0-0 libxcursor1 libxfixes3 libfreetype6 libavahi-client3 
libgssapi-krb5-2 libtiff5 fontconfig-config libgdk-pixbuf2.0-common libgdk-pixbuf2.0-0 libfontconfig1 libcups2 
libcairo2 libc6-dev linux-libc-dev libatk1.0-0 libx11-xcb-dev libxtst6 libxss-dev libxss1 libgconf-2-4 
libasound2 libnss3 zlib1g"
  - os: linux
    env:
     - arch="armhf"
     - COBBLER_GIT_ENDPOINT=https://github.com/Microsoft/vscode
     - COBBLER_PACKAGES="libgtk2.0-0 libxkbfile-dev 
libx11-dev libxdmcp-dev libdbus-1-3 libpcre3 libselinux1 libp11-kit0 libcomerr2 libk5crypto3 
libkrb5-3 libpango-1.0-0 libpangocairo-1.0-0 libpangoft2-1.0-0 libxcursor1 libxfixes3 libfreetype6 libavahi-client3 
libgssapi-krb5-2 libtiff5 fontconfig-config libgdk-pixbuf2.0-common libgdk-pixbuf2.0-0 libfontconfig1 libcups2 
libcairo2 libc6-dev linux-libc-dev libatk1.0-0 libx11-xcb-dev libxtst6 libxss-dev libxss1 libgconf-2-4 
libasound2 libnss3 zlib1g"
    
notifications:
  email: false
  
before_install:
  - gem install package_cloud;
  - sudo apt-get install -y tree;
  - docker pull headmelted/cobbler:$arch;

script:
  # - if [[ "${TRAVIS_TAG}" =~ ^20.*$ ]]; then
  - sudo bash -c '. ./dock.sh';
    # else
    #   if [[ "${LABEL}" == "armhf_linux" ]]; then
    #     echo "Merging packages repository back up to Github Pages...";
    #     . ./tools/merge.sh;
    #   fi;
    # fi;
  
  
after_success:
  - package_cloud push headmelted/codebuilds/ubuntu/xenial $(pwd)/cooked/*.deb
  - package_cloud push headmelted/codebuilds/fedora/24 $(pwd)/cooked/*.rpm

deploy:
  provider: releases
  api_key: "$GITHUB_TOKEN"
  file_glob: true
  file:
    - $(pwd)/cooked/*.*
  skip_cleanup: true
  on:
    repo: headmelted/codebuilds
    tags: true
 
